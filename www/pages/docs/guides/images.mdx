import { I18nText } from '../../../components/site/I18nProvider'

# <I18nText en="Handling Image Uploads" zh="处理图片上传" />

<I18nText
  en="Use remote URLs for production. Avoid persisting Base64 image payloads in your document JSON."
  zh="生产环境建议使用远程 URL，不要把 Base64 图片直接持久化到文档 JSON。"
/>

## <I18nText en="Why default Base64 flow is risky" zh="为什么默认 Base64 流程有风险" />

- <I18nText en="Large payloads and slow save requests." zh="文档体积变大，保存请求变慢。" />
- <I18nText en="Higher database cost and poor caching behavior." zh="数据库存储成本更高，缓存命中更差。" />
- <I18nText en="Harder image lifecycle management." zh="图片生命周期管理更困难。" />

## <I18nText en="Upload then insert URL" zh="先上传再插入 URL" />

```tsx
import type { Editor } from '@tiptap/core'
import type { EditorProps } from '@tiptap/pm/view'
import { HybricEditor } from 'hybricmark'

async function uploadToCloudinary(file: File): Promise<string> {
  const form = new FormData()
  form.append('file', file)
  form.append('upload_preset', '<your-preset>')

  const res = await fetch('https://api.cloudinary.com/v1_1/<cloud-name>/image/upload', {
    method: 'POST',
    body: form,
  })
  if (!res.ok) throw new Error('Image upload failed')

  const data = (await res.json()) as { secure_url: string }
  return data.secure_url
}

const isImageFile = (file: File) => file.type.startsWith('image/')

async function uploadAndInsertImage(editor: Editor, file: File) {
  const url = await uploadToCloudinary(file)
  editor.chain().focus().setImage({ src: url }).run()
}

const editorProps: EditorProps = {
  handlePaste(view, event) {
    const files = Array.from(event.clipboardData?.files ?? []).filter(isImageFile)
    if (!files.length) return false
    event.preventDefault()
    const editor = (view as unknown as { editor?: Editor }).editor
    if (!editor) return true
    void Promise.all(files.map((file) => uploadAndInsertImage(editor, file)))
    return true
  },
  handleDrop(view, event) {
    const files = Array.from(event.dataTransfer?.files ?? []).filter(isImageFile)
    if (!files.length) return false
    event.preventDefault()
    const editor = (view as unknown as { editor?: Editor }).editor
    if (!editor) return true
    void Promise.all(files.map((file) => uploadAndInsertImage(editor, file)))
    return true
  },
}

export default function EditorWithUpload() {
  return <HybricEditor content="# Image Demo" editorProps={editorProps} />
}
```

## <I18nText en="UX tips" zh="体验建议" />

- <I18nText en="Show `Uploading...` placeholder near cursor while request is pending." zh="上传过程中在光标附近显示 `Uploading...` 占位。" />
- <I18nText en="Show actionable error UI, not only console logs." zh="上传失败要给可见错误提示，不要只打控制台。" />
- <I18nText en="Apply server-side file validation (type/size/security scan)." zh="服务端务必做文件类型、大小和安全扫描校验。" />
